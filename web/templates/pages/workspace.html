{{define "title"}}{{.Title}}{{end}}

{{define "head"}}
<link rel="stylesheet" href="/static/dist/xterm.css">
<script src="/static/dist/xterm-bundle.js"></script>
<script src="/static/js/terminal.js"></script>
<script src="/static/js/modifier-keys.js"></script>
<script src="/static/js/pane-layout.js"></script>
<script src="/static/dist/codemirror-bundle.js"></script>
<script src="/static/js/editor.js"></script>
<script src="/static/js/docker.js"></script>
<script src="/static/js/snippets.js"></script>
{{end}}

{{define "body"}}
<div class="flex h-full" x-data="{ sidebarOpen: false }">
    <!-- Mobile sidebar overlay -->
    <div x-show="sidebarOpen" x-cloak
         class="fixed inset-0 z-40 bg-black/50 lg:hidden"
         @click="sidebarOpen = false"></div>

    <!-- Sidebar -->
    <aside class="fixed inset-y-0 left-0 z-50 w-72 bg-gray-900 border-r border-gray-800 transform transition-transform duration-200 lg:relative lg:translate-x-0"
           :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'">
        <div class="flex items-center justify-between h-14 px-4 border-b border-gray-800">
            <a href="/" hx-boost="false" class="flex items-center gap-2 text-lg font-semibold text-white">
                <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                ClawIDE
            </a>
            <button @click="sidebarOpen = false" class="lg:hidden p-1 rounded text-gray-400 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <nav class="p-3 space-y-1 overflow-y-auto h-[calc(100%-3.5rem)]">
            <a href="/" hx-boost="false" class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-300 hover:bg-gray-800 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                All Projects
            </a>

            <div class="mt-4">
                <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Sessions</h3>
                <div id="session-sidebar" class="mt-2 space-y-1">
                    {{range .Sessions}}
                    <div class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-300 hover:bg-gray-800 cursor-pointer">
                        <span class="w-2 h-2 rounded-full bg-green-500 flex-shrink-0"></span>
                        <span class="truncate">{{.Name}}</span>
                    </div>
                    {{end}}
                </div>

                <button hx-post="/projects/{{.Project.ID}}/sessions/"
                        hx-vals='{"name": ""}'
                        hx-swap="none"
                        class="mt-2 flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-500 hover:text-gray-300 hover:bg-gray-800 w-full">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Session
                </button>
            </div>

            <div class="mt-4 border-t border-gray-800 pt-4">
                <a href="/settings" class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-300 hover:bg-gray-800 hover:text-white">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Settings
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main content -->
    <div class="flex-1 flex flex-col min-w-0" x-data="{ activeTab: '{{.ActiveTab}}' }">
        <!-- Top bar -->
        <header class="flex items-center h-14 px-4 border-b border-gray-800 bg-gray-900/50 backdrop-blur">
            <button @click="sidebarOpen = true" class="lg:hidden p-1.5 mr-3 rounded text-gray-400 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <nav class="flex items-center gap-2 text-sm">
                <a href="/" hx-boost="false" class="text-gray-400 hover:text-white">Dashboard</a>
                <span class="text-gray-600">/</span>
                <span class="text-white font-medium truncate">{{.Project.Name}}</span>
            </nav>
            <div class="ml-auto">
                <button id="snippet-toggle" class="p-1.5 rounded text-gray-400 hover:text-white hover:bg-gray-800 transition-colors" title="Snippets">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 18l2-2-2-2"/><path d="M8 18l-2-2 2-2"/><path d="M11.5 12h1"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Workspace content -->
        <div class="flex flex-col flex-1 min-h-0">
            <!-- Desktop tab bar -->
            <div class="hidden lg:flex items-center gap-1 px-4 border-b border-gray-800 bg-gray-900/30">
                <button @click="activeTab = 'terminal'"
                        :class="activeTab === 'terminal' ? 'text-white border-indigo-400' : 'text-gray-400 border-transparent hover:text-gray-200'"
                        class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors">
                    Terminal
                </button>
                <button @click="activeTab = 'files'"
                        :class="activeTab === 'files' ? 'text-white border-indigo-400' : 'text-gray-400 border-transparent hover:text-gray-200'"
                        class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors">
                    Files
                </button>
                <button @click="activeTab = 'docker'"
                        :class="activeTab === 'docker' ? 'text-white border-indigo-400' : 'text-gray-400 border-transparent hover:text-gray-200'"
                        class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors">
                    Docker
                </button>
                <button @click="activeTab = 'ports'"
                        :class="activeTab === 'ports' ? 'text-white border-indigo-400' : 'text-gray-400 border-transparent hover:text-gray-200'"
                        class="px-4 py-2.5 text-sm font-medium border-b-2 transition-colors">
                    Ports
                </button>
            </div>

            <!-- Tab content -->
            <div class="flex-1 overflow-hidden">
                <!-- Terminal panel -->
                <div x-show="activeTab === 'terminal'" class="h-full flex flex-col"
                     x-data="{ activeSession: '{{if .Sessions}}{{(index .Sessions 0).ID}}{{end}}' }"
                     x-init="if (activeSession) { $nextTick(() => initSessionPanes(activeSession)) }">

                    {{if .Sessions}}
                    <!-- Session tabs with rename and close -->
                    <div class="flex items-center gap-1 px-2 py-1 border-b border-gray-800 bg-gray-900/50 overflow-x-auto">
                        {{range .Sessions}}
                        <div class="group flex items-center gap-1 rounded transition-colors"
                             :class="activeSession === '{{.ID}}' ? 'bg-gray-800' : 'hover:bg-gray-800/50'">
                            <button @click="activeSession = '{{.ID}}'; $nextTick(() => initSessionPanes('{{.ID}}'))"
                                    :class="activeSession === '{{.ID}}' ? 'text-white' : 'text-gray-400 hover:text-gray-200'"
                                    class="flex items-center gap-1.5 px-3 py-1 text-xs font-medium whitespace-nowrap transition-colors">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                <span class="session-name"
                                      contenteditable="false"
                                      data-session-id="{{.ID}}"
                                      data-project-id="{{$.Project.ID}}"
                                      @dblclick.stop="$el.contentEditable = 'true'; $el.focus(); document.execCommand('selectAll', false, null)"
                                      @blur="$el.contentEditable = 'false'; renameSession('{{$.Project.ID}}', '{{.ID}}', $el.textContent.trim())"
                                      @keydown.enter.prevent="$el.blur()">{{.Name}}</span>
                            </button>
                            <button class="hidden group-hover:block text-gray-500 hover:text-red-400 pr-1.5 text-xs transition-colors"
                                    @click.stop="if (confirm('Close session &quot;{{.Name}}&quot;?')) deleteSession('{{$.Project.ID}}', '{{.ID}}')"
                                    title="Close session">&#x2715;</button>
                        </div>
                        {{end}}
                    </div>

                    <!-- Pane layout containers (one per session, rendered by pane-layout.js) -->
                    {{range .Sessions}}
                    <div x-show="activeSession === '{{.ID}}'"
                         id="session-panes-{{.ID}}"
                         class="flex-1 flex bg-black min-h-0"
                         data-layout='{{json .Layout}}'
                         data-session-id="{{.ID}}"
                         data-project-id="{{$.Project.ID}}"></div>
                    {{end}}
                    {{else}}
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-sm">Create a session to start a terminal</p>
                        </div>
                    </div>
                    {{end}}

                    <!-- Virtual modifier keys toolbar (touch devices only) -->
                    <div id="modifier-toolbar" class="modifier-toolbar" role="toolbar" aria-label="Terminal modifier keys">
                        <!-- Modifier keys (toggle/lock) -->
                        <button data-modifier="ctrl" aria-pressed="false">Ctrl</button>
                        <button data-modifier="alt" aria-pressed="false">Alt</button>
                        <button data-modifier="meta" aria-pressed="false">Cmd</button>

                        <div class="modifier-separator"></div>

                        <!-- Direct send keys -->
                        <button data-key="tab">Tab</button>
                        <button data-key="esc">Esc</button>

                        <div class="modifier-separator"></div>

                        <!-- Arrow keys -->
                        <button data-key="left" aria-label="Left arrow">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                        </button>
                        <button data-key="down" aria-label="Down arrow">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </button>
                        <button data-key="up" aria-label="Up arrow">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
                        </button>
                        <button data-key="right" aria-label="Right arrow">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                        </button>

                        <div class="modifier-separator"></div>

                        <!-- Clipboard -->
                        <button data-action="copy" aria-label="Copy">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        </button>
                        <button data-action="paste" aria-label="Paste">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Files panel -->
                <div x-show="activeTab === 'files'" x-cloak class="h-full flex"
                     x-data="{ fileTree: [], currentFile: null, fileContent: '' }">

                    <!-- File tree sidebar -->
                    <div class="w-64 border-r border-gray-800 overflow-y-auto bg-gray-900/50 flex-shrink-0">
                        <div class="p-2 border-b border-gray-800">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase px-2">Files</h3>
                        </div>
                        <div id="file-tree" class="p-1">
                            <div class="text-gray-500 text-xs p-2">Loading...</div>
                        </div>
                        <script>
                        (function() {
                            var projectID = '{{.Project.ID}}';
                            function loadDir(path, container, depth) {
                                fetch('/projects/' + projectID + '/api/files' + (path ? '?path=' + encodeURIComponent(path) : ''))
                                    .then(function(r) { return r.json(); })
                                    .then(function(files) {
                                        var html = '';
                                        files.forEach(function(f) {
                                            var indent = 'padding-left:' + ((depth || 0) * 16 + 8) + 'px';
                                            if (f.is_dir) {
                                                html += '<div class="file-tree-item" style="' + indent + '" data-path="' + f.path + '" onclick="toggleDir(this, \'' + projectID + '\', \'' + f.path + '\', ' + ((depth||0)+1) + ')">';
                                                html += '<span class="text-gray-500">&#9654;</span> ' + f.name;
                                                html += '</div><div class="hidden" data-children="' + f.path + '"></div>';
                                            } else {
                                                html += '<div class="file-tree-item" style="' + indent + '" data-filepath="' + f.path + '" onclick="ClawIDEEditor.loadFile(\'' + projectID + '\', \'' + f.path + '\')">';
                                                html += '<span class="text-gray-500 text-xs">&#9643;</span> ' + f.name;
                                                html += '</div>';
                                            }
                                        });
                                        container.innerHTML = html || '<div class="text-gray-500 text-xs p-2">Empty</div>';
                                    })
                                    .catch(function() {
                                        container.innerHTML = '<div class="text-gray-500 text-xs p-2">Failed to load</div>';
                                    });
                            }
                            window.toggleDir = function(el, pid, path, depth) {
                                var children = el.nextElementSibling;
                                if (children.classList.contains('hidden')) {
                                    children.classList.remove('hidden');
                                    el.querySelector('span').innerHTML = '&#9660;';
                                    if (!children.dataset.loaded) {
                                        loadDir(path, children, depth);
                                        children.dataset.loaded = 'true';
                                    }
                                } else {
                                    children.classList.add('hidden');
                                    el.querySelector('span').innerHTML = '&#9654;';
                                }
                            };
                            loadDir('', document.getElementById('file-tree'), 0);
                        })();
                        </script>
                    </div>

                    <!-- Editor area -->
                    <div id="editor-pane-root" class="flex-1 flex min-w-0"
                         data-project-id="{{.Project.ID}}">
                        <!-- Empty state shown when no file is open -->
                        <div id="editor-empty-state" class="flex items-center justify-center flex-1 text-gray-500">
                            <div class="text-center">
                                <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                </svg>
                                <p class="text-sm">Select a file to edit</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Docker panel -->
                <div x-show="activeTab === 'docker'" x-cloak class="h-full flex flex-col"
                     x-data="{ services: [] }">
                    <div class="flex items-center gap-2 px-4 py-2 border-b border-gray-800">
                        <h3 class="text-sm font-medium text-white">Docker Compose</h3>
                        <div class="ml-auto flex gap-1">
                            <button onclick="ClawIDEDocker.composeUp('{{.Project.ID}}')"
                                    class="px-3 py-1 text-xs bg-green-600 hover:bg-green-500 text-white rounded transition-colors">
                                Up
                            </button>
                            <button onclick="ClawIDEDocker.composeDown('{{.Project.ID}}')"
                                    class="px-3 py-1 text-xs bg-red-600 hover:bg-red-500 text-white rounded transition-colors">
                                Down
                            </button>
                            <button onclick="ClawIDEDocker.refresh('{{.Project.ID}}', document.getElementById('docker-services'))"
                                    class="px-3 py-1 text-xs text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors">
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div id="docker-services" class="flex-1 overflow-y-auto"
                         x-init="if (typeof ClawIDEDocker !== 'undefined') ClawIDEDocker.refresh('{{.Project.ID}}', $el)">
                        <div class="text-gray-500 text-sm p-4">Loading services...</div>
                    </div>
                </div>

                <!-- Ports panel -->
                <div x-show="activeTab === 'ports'" x-cloak class="h-full overflow-y-auto"
                     x-data="{ ports: { os_ports: [], compose_ports: [] } }"
                     x-init="fetch('/projects/{{.Project.ID}}/api/ports').then(r => r.json()).then(d => ports = d).catch(() => {})">

                    <div class="p-4 space-y-4">
                        <h3 class="text-sm font-medium text-white">Detected Ports</h3>

                        <template x-if="ports.os_ports && ports.os_ports.length > 0">
                            <div>
                                <h4 class="text-xs text-gray-500 uppercase mb-2">System Ports</h4>
                                <div class="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
                                    <template x-for="(p, idx) in ports.os_ports" :key="idx">
                                        <a :href="'http://localhost:' + p.number" target="_blank"
                                           class="block bg-gray-900 border border-gray-800 rounded-lg p-3 hover:border-gray-700 transition-colors">
                                            <div class="flex items-center gap-2">
                                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                                <span class="text-sm font-mono text-white" x-text="':' + p.number"></span>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1 truncate" x-text="p.process"></p>
                                        </a>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <template x-if="ports.compose_ports && ports.compose_ports.length > 0">
                            <div>
                                <h4 class="text-xs text-gray-500 uppercase mb-2">Compose Ports</h4>
                                <div class="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
                                    <template x-for="(p, idx) in ports.compose_ports" :key="idx">
                                        <a :href="'http://localhost:' + p.host_port" target="_blank"
                                           class="block bg-gray-900 border border-gray-800 rounded-lg p-3 hover:border-gray-700 transition-colors">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm font-mono text-white" x-text="':' + p.host_port + ' -> :' + p.container_port"></span>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1" x-text="p.service"></p>
                                        </a>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <template x-if="(!ports.os_ports || ports.os_ports.length === 0) && (!ports.compose_ports || ports.compose_ports.length === 0)">
                            <div class="text-gray-500 text-sm">No ports detected</div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile bottom tab bar -->
        <div class="lg:hidden flex items-center justify-around border-t border-gray-800 bg-gray-900 safe-bottom">
            <button @click="activeTab = 'terminal'"
                    :class="activeTab === 'terminal' ? 'text-indigo-400' : 'text-gray-500'"
                    class="flex flex-col items-center gap-0.5 py-2 px-3 min-h-[44px] min-w-[44px]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="text-[10px]">Terminal</span>
            </button>
            <button @click="activeTab = 'files'"
                    :class="activeTab === 'files' ? 'text-indigo-400' : 'text-gray-500'"
                    class="flex flex-col items-center gap-0.5 py-2 px-3 min-h-[44px] min-w-[44px]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                <span class="text-[10px]">Files</span>
            </button>
            <button @click="activeTab = 'docker'"
                    :class="activeTab === 'docker' ? 'text-indigo-400' : 'text-gray-500'"
                    class="flex flex-col items-center gap-0.5 py-2 px-3 min-h-[44px] min-w-[44px]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                </svg>
                <span class="text-[10px]">Docker</span>
            </button>
            <button @click="activeTab = 'ports'"
                    :class="activeTab === 'ports' ? 'text-indigo-400' : 'text-gray-500'"
                    class="flex flex-col items-center gap-0.5 py-2 px-3 min-h-[44px] min-w-[44px]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/>
                </svg>
                <span class="text-[10px]">Ports</span>
            </button>
        </div>
    </div>
</div>

<!-- Snippet drawer overlay -->
<div id="snippet-overlay" class="snippet-overlay"></div>

<!-- Snippet floating drawer -->
<div id="snippet-drawer" class="snippet-drawer">
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-800">
        <h2 class="text-sm font-semibold text-white">Snippets</h2>
        <button onclick="ClawIDESnippets.close()" class="text-gray-400 hover:text-white p-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <!-- Search -->
    <div class="px-4 py-2 border-b border-gray-800">
        <input id="snippet-search" type="text" placeholder="Search snippets..."
               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
    </div>

    <!-- Create/Edit form -->
    <div class="px-4 py-3 border-b border-gray-800">
        <h3 id="snippet-form-title" class="text-xs font-semibold text-gray-400 uppercase mb-2">New Snippet</h3>
        <form id="snippet-form" class="space-y-2">
            <input id="snippet-name" type="text" placeholder="Snippet name" required
                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
            <textarea id="snippet-content" placeholder="Snippet content..." rows="3"
                      class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 font-mono resize-y"></textarea>
            <div class="flex items-center gap-2">
                <button type="submit"
                        class="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-500 text-white rounded transition-colors">
                    Save
                </button>
                <button type="button" id="snippet-cancel" style="display:none"
                        class="px-3 py-1 text-xs text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Snippet list -->
    <div id="snippet-list" class="flex-1 overflow-y-auto"></div>
</div>

<script>
function initSessionPanes(sessionID) {
    var container = document.getElementById('session-panes-' + sessionID);
    if (!container) return;

    var layoutStr = container.getAttribute('data-layout');
    var projectID = container.getAttribute('data-project-id');

    if (!layoutStr) return;

    // Check if already rendered (has child elements with pane terminals)
    if (container.children.length > 0) {
        // Already rendered â€” just refit existing terminals
        return;
    }

    try {
        var layout = JSON.parse(layoutStr);
        window.ClawIDEPaneLayout.render(container, layout, sessionID, projectID);
    } catch(e) {
        console.error('Failed to parse pane layout:', e);
    }
}

function renameSession(projectID, sessionID, newName) {
    if (!newName) return;
    fetch('/projects/' + projectID + '/sessions/' + sessionID, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'HX-Request': 'true' },
        body: 'name=' + encodeURIComponent(newName),
    }).catch(function(err) {
        console.error('Failed to rename session:', err);
    });
}

function deleteSession(projectID, sessionID) {
    fetch('/projects/' + projectID + '/sessions/' + sessionID, {
        method: 'DELETE',
        headers: { 'HX-Request': 'true' },
    }).then(function() {
        window.location.reload();
    }).catch(function(err) {
        console.error('Failed to delete session:', err);
    });
}
</script>
{{end}}
